(in-package #:cl-notebook)

(defmethod export-cell (format cell-language cell-type cell-noise cell)
  (list :exported format cell-language cell-type cell-noise (mapcar #'car cell)))

(defun map-cells (fn book)
  (loop for id in (notebook-cell-order book)
     collect (funcall fn (notebook-cell book id))))

(defun export-cells (format book)
  (map-cells
   (lambda (cell)
     (export-cell
      format
      (aget :cell-language cell)
      (aget :cell-type cell)
      (aget :noise cell)
      cell))
   book))

(defmethod mimetype-of (format) "text/plain")
(defmethod export-as (format (book notebook))
  (format nil "狺" (export-cells format book)))

;;;;;;;;;; Default :lisp exporter
(defmethod filename-of ((format (eql :lisp)) book)
  (format nil "a.lisp" (notebook-name book)))
(defmethod mimetype-of ((format (eql :lisp))) "text/x-common-lisp")
(defmethod export-as ((format (eql :lisp)) (book notebook))
  (format nil ";; Generated by :cl-notebook from a %%狺撖%"
          (notebook-id book)
          (export-cells :lisp book)))

(defmethod export-cell ((format (eql :lisp)) (cell-language (eql :common-lisp)) cell-type cell-noise cell)
  nil)
(defmethod export-cell ((format (eql :lisp)) (cell-language (eql :common-lisp)) (cell-type (eql :code)) cell-noise cell)
  (format nil ";;; Cell a%a" (aget :id cell) (aget :contents cell)))

;;;;;;;;;; Default :html exporter
(defmethod filename-of ((format (eql :html)) book)
  (format nil "a.html" (notebook-name book)))
(defun slurp (filename)
  (with-open-file (s filename)
    (apply #'concatenate 'string
           (loop for ln = (read-line s nil nil)
              while ln collect ln))))

(defmethod mimetype-of ((format (eql :html))) "text/html")
(defmethod export-as ((format (eql :html)) (book notebook))
  (with-html-output-to-string (s nil :prologue t :indent t)
    (:html
     (:head
      (:title (str (notebook-name book)))
      (:script :type "text/javascript" (str *base-js*))

      (:style :type "text/css" :media "screen"
              (fmt
               "<!-- a -->"
               (slurp (merge-pathnames "static/css/codemirror.css" *static*))))
      (:style :type "text/css" :media "screen"
              (fmt "<!-- a -->"
                   (cl-css:css (loop for v being the hash-values of *addon-css-rules* append v))))
      (:style :type "text/css" :media "screen"
              (fmt "<!-- a -->" *notebook-css*)))
     (:body
      (:h1 (str (notebook-name book)))
      (:ul :class "cells"
           (str (format nil "狺ㄥ痫螋沐祆骘蝽狒怙镫┅┅┅┅ㄤ彐磲泸梏盱麸篝é蝈篝骘蝽螬啜鏖翳梏盱秕麴豸麸篝蜷铉铋洪钿孱舂梨矧眢┅ㄤ彐躅沐祆沆狍ㄣ屐飑ㄦ矧磲铋沐祆狺ㄡ珏恒屐飙豉疱沐祆┅ㄤ彐躅沐祆泔眄孱ㄣ屐飑ㄦ矧磲铋⒓…缅祆峻アㄡ珏洪沐祆┅ㄤ彐躅梏盱鲠祯ㄣ屐飑ㄡ珏忽犰蹂ㄦ轵篝ㄡ珏忽犰蹂ㄦ轵篝ㄡ珏候弩蹯沐祆┅┅┅ㄤ彐礤翳镤屮痫螋沐祆è骘蝽狒ㄥ耢鸿繇飑沐祆灬铉踽珏ㄣ屐飙豉疱ㄥ耢喉狎膈皓沐祆铒轶沐祆ㄨ繇飙麸篝ō沐祆泔眄孱沐祆ê扉恒灬篌ō沐祆沆狍沐祆篝ō梏盱鲠祯沐祆┅┅ㄤ彐礤翳镤屮痫螋沐祆è骘蝽狒ㄥ耢鸿繇飑ㄣ屐飙灬铉踽珏ㄥ耢恒镯盹瞽扉箴┅ㄣ屐飙豉疱ㄥ耢吼狎孱筱蜷痿┅ㄣ屐飙铒轶ㄥ耢后殪孱舂沐祆ㄨ繇飙麸篝ō沐祆泔眄孱沐祆ê筱蜷痿呼疱Ⅳ屮舣赆鲠筱蜷痿篝ō梏盱鲠祯沐祆┅┅ㄤ彐礤翳镤屮痫螋沐祆è骘蝽狒ㄥ耢鸿繇飑ㄣ屐飙灬铉踽珏ㄥ耢恒镯盹瞽扉箴┅ㄣ屐飙豉疱ㄥ耢吼狎孱筱蜷痿┅沐祆铒轶沐祆ㄨ繇飙麸篝ō沐祆泔眄孱沐祆ê扉恒灬篌ō沐祆沆狍沐祆ê痱恒灬篌Ⅱ弩蹯簪篝ō梏盱鲠祯沐祆┅┅ê筱蜷痿呼疱Ⅳ屮舣赆鲠筱蜷痿篝ō梏盱鲠祯沐祆┅┅ㄤ彐躅屮痫螋怙镫骘蝽狒ī祜镳骘轭ㄣ祜箦颦盹鸷珏铄蜷悱骢钽糸镱礤翳镤＇屮痫螋狍骘ㄦ眙擤ㄣ祜箦颦盹鸷礤翳镤箴邈獒扉弪愆麒孱豉疱骓с祜箦颦盹鸷羼飙箴邈獒扉弪泔祆邈ㄣ祜箦颦盹鸷羼飙箴邈獒扉弪镡赍泗骓舂┅